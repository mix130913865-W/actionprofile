# ------------------------------------------------------
# Workflow åç¨±ï¼šæœƒé¡¯ç¤ºåœ¨ GitHub Actions é é¢å·¦å´æ¸…å–®
# ------------------------------------------------------
name: Vprofile CICD Workflow

# ------------------------------------------------------
# on: ä»£è¡¨è§¸ç™¼æ¢ä»¶ï¼ˆä»€éº¼æ™‚å€™è¦åŸ·è¡Œé€™å€‹ Pipelineï¼‰
# ------------------------------------------------------
on:

  # 1) pushï¼šç•¶ push åˆ° main æˆ– develop æ™‚åŸ·è¡Œ
  push:
    branches: [ "main", "develop" ]

  # 2) pull_requestï¼šç•¶ PR çš„ç›®æ¨™åˆ†æ”¯æ˜¯ main / develop æ™‚åŸ·è¡Œ
  pull_request:
    branches: [ "main", "develop" ]

  # 3) workflow_dispatchï¼šå…è¨±æ‰‹å‹• Run workflow
  workflow_dispatch:

  # 4) scheduleï¼šå®šæ™‚æ’ç¨‹ï¼ˆå·¥ä½œå¤© 14:10 UTCï¼‰
  #    â†’ å°ç£æ™‚é–“ 22:10 (Monâ€“Fri)
  schedule:
    - cron: "10 14 * * 1-5"

# ------------------------------------------------------
# permissionsï¼šè¨­å®š GitHub Token æ¬Šé™ï¼Œé™ä½è³‡å®‰é¢¨éšª
# ------------------------------------------------------
permissions:
  contents: read   # åªå…è¨±è®€å– repoï¼Œä¸å…è¨±å¯«å…¥

# ------------------------------------------------------
# jobsï¼šå®šç¾© Buildã€Testing ç­‰å·¥ä½œéšæ®µ
# ------------------------------------------------------
jobs:

  # ======================================================
  # ç¬¬ä¸€å€‹ Jobï¼šBuildï¼ˆç·¨è­¯ã€æ‰“åŒ…ã€ç”¢å‡º WAR + å¤±æ•—é€šçŸ¥ï¼‰
  # ======================================================
  Build:
    runs-on: ubuntu-latest    # GitHub æä¾›çš„ Ubuntu Runner

    steps:
      # --------------------------------------------------
      # Step 1ï¼šå°‡ Repo åŸå§‹ç¢¼ checkout ä¸‹ä¾†
      # --------------------------------------------------
      - name: Code checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0      # ä¸‹è¼‰å®Œæ•´ Git æ­·å²ï¼ˆé¿å…æ’ä»¶æ‰¾ä¸åˆ° commitï¼‰

      # --------------------------------------------------
      # Step 2ï¼šä½¿ç”¨ Maven é€²è¡Œå»ºç½®
      # mvn install = compile + test + package
      # --------------------------------------------------
      - name: Maven Build
        run: mvn install

      # --------------------------------------------------
      # Step 3ï¼šä¸Šå‚³ Build å¾Œçš„ Artifactï¼ˆWAR æª”ï¼‰
      #         å¯åœ¨ Actions â†’ Artifacts ä¸­ä¸‹è¼‰
      # --------------------------------------------------
      - name: Upload Build Artifact (WAR)
        uses: actions/upload-artifact@v4
        with:
          name: vprofile-app   # Artifact åç¨±
          path: target/*.war   # æŒ‡å®šè¦ä¸Šå‚³çš„ WAR æª”è·¯å¾‘

      # --------------------------------------------------
      # Step 4ï¼šè‹¥ Build Job å¤±æ•—å‰‡é€šçŸ¥ï¼ˆç°¡æ˜“ echo ç‰ˆæœ¬ï¼‰
      # --------------------------------------------------
      - name: Notify if Build Fails
        if: failure()          # åƒ…ç•¶ Build Job å¤±æ•—æ™‚æ‰åŸ·è¡Œ
        run: echo "ğŸš¨ Build job failed! Please check logs."


  # ======================================================
  # ç¬¬äºŒå€‹ Jobï¼šTestingï¼ˆä¾æ¢ä»¶åŸ·è¡Œ test / checkstyleï¼‰
  # ======================================================
  Testing:
    runs-on: ubuntu-latest

    # needs: Build â†’ Build Job æˆåŠŸå¾Œæ‰åŸ·è¡Œ Testing
    needs: Build

    steps:
      # --------------------------------------------------
      # Step 1ï¼šå†æ¬¡ checkout åŸå§‹ç¢¼ï¼ˆæ¯å€‹ job éƒ½å¿…é ˆè‡ªå·± checkoutï¼‰
      # --------------------------------------------------
      - name: Code checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # Step 2ï¼šåœ¨ main åˆ†æ”¯åŸ·è¡Œå–®å…ƒæ¸¬è©¦
      # --------------------------------------------------
      - name: Run tests on main branch
        if: github.ref == 'refs/heads/main'   # æ¢ä»¶ï¼šåªæœ‰ main æ‰è·‘ test
        run: mvn test

      # --------------------------------------------------
      # Step 3ï¼šåœ¨ main åˆ†æ”¯åŸ·è¡Œ Checkstyle é¢¨æ ¼æª¢æŸ¥
      # --------------------------------------------------
      - name: Checkstyle
        if: github.ref == 'refs/heads/main'   # æ¢ä»¶ï¼šåªæœ‰ main æ‰è·‘ checkstyle
        run: mvn checkstyle:checkstyle

      # --------------------------------------------------
      # Step 4ï¼šå…¶ä»–åˆ†æ”¯è·³éæ¸¬è©¦èˆ‡éœæ…‹åˆ†æï¼ˆåŠ é€Ÿ CIï¼‰
      # --------------------------------------------------
      - name: Run tests on other branches
        if: github.ref != 'refs/heads/main'
        run: echo "Skipping unit tests and code analysis"
